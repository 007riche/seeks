<!DOCTYPE HTML>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<title>qclean - Seeks Search</title>
<link rel="search" href="opensearch.xml" type="application/opensearchdescription+xml" title="Seeks Search" />
<link rel="stylesheet" href="@base-url@/public/yui/3.0.0/cssreset/reset-min.css" type="text/css" />
<link rel="stylesheet" href="@base-url@/public/yui/3.0.0/cssfonts/fonts-min.css" type="text/css" />
<link rel="stylesheet" href="@base-url@/public/yui/3.0.0/cssgrids/grids-min.css" type="text/css" />
<link rel="stylesheet" href="@base-url@/public/css/base.css" type="text/css" />
<link rel="stylesheet" href="seeks_search.css" type="text/css" />
<link rel="stylesheet" href="seeks_img_search.css" type="text/css" />
<link rel="shortcut icon" type="image/png" href="/public/images/seek_icon_32x32_transparent.png" />
</head>

<body>

#include info-head

<div id="search_bar">
<form method="GET" action="@base-url@/search" id="search_form" onsubmit="return false;">
<input title="Search (ctrl+f)" id="search_input" autocomplete="off" name="q" maxlength="2048" value="qclean" type="text" />
<input name="qknown" value="fullquery" type="hidden" />
<input name="expansion" value="1" type="hidden" />
<input name="action" value="expand" type="hidden" />
<!-- <input name="engines" value="xxeng" type="hidden" /> -->
<input name="content_analysis" value="xxca" type="hidden" />
<input name="ui" value="dyn" type="hidden" />
<input name="output" value="json" type="hidden" />
<input id="search_button" value="" type="submit" />
</form>

<a id="expansion" href="javascript:void(null);" title="Expand. Deeper search, towards a broader range of results."></a>

<!-- @if-have-clustering-start -->
<a href="@base-url@/search?q=fullquery&amp;expansion=xxexp&amp;action=clusterize&amp;clusters=xxnclust&amp;engines=xxeng&amp;rpp=xxrpp&amp;content_analysis=xxcca&amp;prs=xxpers" title="Cluster (ctrl+c)" id="cluster" class="cluster_off">&nbsp;</a>
<!-- if-have-clustering-end@ -->
<!-- @if-not-have-clustering-start -->
<a href="" title="Cluster (not activated by this node)" id="cluster" class="cluster_inactive">&nbsp;</a>
<!-- if-not-have-clustering-end@ -->

<!-- @if-have-one-column-results-head-start -->
<!-- <div id="search_pages">xxprev<span id="search_page_current">xxpage</span>xxnext<small>page</small></div> -->
<div id="search_pages"></div>
<!-- if-have-one-column-results-head-end@ -->
<!-- @if-have-clustered-results-head-start -->
<!-- <div id="search_pages"><a href="@base-url@/search?q=fullquery&amp;page=xxpage&amp;expansion=xxexp&amp;action=expand&amp;engines=xxeng&amp;rpp=xxrpp&amp;content_analysis=xxca&amp;prs=xxpers" id="search_page_prev" title="Back to list of results">&nbsp;</a><small>back</small></div> -->
<!-- if-have-clustered-results-head-end@ -->

<a id="search_home" title="Home (ctrl+h)" href="@base-url@/websearch-hp/">&nbsp;</a>

<div id="search_sugg"></div>

<div id="search_bar_tab">
<a class="search_bar_tab" href="http://www.seeks-project.info/wiki/index.php/Tips_%26_Troubleshooting#I_don.27t_get_search_results_in_the_language_I_want">Lang:</a> <span id="tab-language"></span>

<a id="tab-pers" class="search_bar_tab" href="javascript:void(null);" title="Toggle personalization">Pers:</a><span id="tab-pers-flag"></span>

<a class="search_bar_tab" href="http://www.seeks-project.info/wiki/index.php/User-Manual_Seeks_Bubs-0.2-SOLO" target="_blank" title="Help">Help</a>

<a id="tab-text" class="search_bar_tab" href="javascript:void(null);" title="Search text">Text</a>
<!-- @if-have-img-websearch-start -->
<a id="tab-img" class="search_bar_tab" href="javascript:void(null);" title="Search images">Images</a>
<!-- if-have-img-websearch-end@ -->
<a id="tab-vid" class="search_bar_tab" href="javascript:void(null);" title="Search videos">Videos</a>
<a id="tab-tweet" class="search_bar_tab" href="javascript:void(null);" title="Search tweets">Tweets</a>
<span class="search_bar_tab">Group by:</span> 
<a id="tab-urls" href="javascript:void(null);" title="Group by urls">urls</a>
<a id="tab-titles" href="javascript:void(null);" title="Group by titles">titles</a>
<a id="tab-types" href="javascript:void(null);" title="Group by type">types</a>
</div>
</div>

<table>
<tr>
<td>

<div id="main">
<div id="search_results">
<ol id="snippets">
</ol>
</div>

<!-- @if-websearch-have-js-start -->
<script type="text/javascript" src="@base-url@/public/yui/3.2.0/yui/yui-min.js"></script>
<!-- <script type="text/javascript" src="http://yui.yahooapis.com/3.2.0/build/yui/yui-min.js"></script> -->
<script type="text/javascript">

YUI().use("jsonp", "substitute", "transition", "querystring", function (Y) {

    // page information.
    var query = "fullquery";
    var enc_query = "fullquery";
    var lang = '';
    
    function page_info()
    {    
	this.rpp = xxrpp;  // results per page.
	this.cpage = 1;  // current page.
	this.engines = '';
	this.expansion = 1;
	this.nexpansion = 2;
	this.prs = "xxpers";
	this.ca = "xxca"; // content analysis.
	this.suggestion = '';
	this.reset = function() {
	    this.cpage = 1;
	    this.engines = '';
	    this.expansion = 1;
	    this.nexpansion = 2;
	    this.suggestion = '';
	};
    }
    var pi_txt = new page_info();
    var pi_img = new page_info();
    pi_img.rpp = 60;
    var pi_vid = new page_info();
    pi_vid.rpp = 40;
    var pi_twe = new page_info();
        
    function type_info()
    {
	this.txt = 1;
	this.img = 0;
	this.vid = 0;
	this.twe = 0;
        this.reset = function() {
	    this.txt = 0;
	    this.img = 0;
	    this.vid = 0;
	    this.twe = 0;
	};
    }
    var ti = new type_info();
    
    function rpage()
    {
	this.prev = '';
	this.next = '';
	this.cpage = 1;
    }

    function sort_meta(s1,s2)
    {
	if (s1.seeks_meta < s2.seeks_meta)
	    return 1;
	else if (s1.seeks_meta > s2.seeks_meta)
	    return -1;
	else {
	    if (s1.rank > s2.rank)
		return 1;
	    else if (s2.rank < s1.rank)
		return -1;
	    else return 0;
	}
    }

    function sort_score(s1,s2)
    {
	if (s1.seeks_score < s2.seeks_score)
	    return 1;
	else if (s1.seeks_score > s2.seeks_score)
	    return -1;
	else return sort_meta(s1,s2);
    }
    
    var ref_url = "@base-url@/search?q=fullquery&expansion=1&action=expand&rpp=10&content_analysis=off&prs=on&output=json&callback={callback}";
    
    var outputDiv = Y.one("#snippets"), expansionLnk = Y.one("#expansion"), suggDiv = Y.one("#search_sugg"),
    pagesDiv = Y.one("#search_pages"), langSpan = Y.one("#tab-language"), persHref = Y.one("#tab-pers"),
    persSpan = Y.one("#tab-pers-flag"), queryInput = Y.one("#search_input");
    
    var hashSnippets = {};
    var nsnippets = 0;

    // result widget.
    function refresh(url)
    {
	//outputDiv.setContent("Seeking...");
	
	var resultsWidget = new Y.JSONPRequest(url, {
        on: {
            success: function (response) {
		lang = response.lang;
		query = response.query;
		enc_query = ':' + lang + '+' + encodeURIComponent(response.query);
		var l = response.snippets.length;
		
		for (i=0; i < l; ++i) 
		{
		    var snippet = response.snippets[i];
                    if (!hashSnippets[snippet.id])
		    {
			nsnippets++;
		    }
		    hashSnippets[snippet.id] = snippet;
		}
			    
		// expansion.
		var pi;
		if (ti.txt == 1)
		    pi = pi_txt;
		else if (ti.img == 1)
		    pi = pi_img;
		else if (ti.vid == 1)
		    pi = pi_vid;
		else if (ti.twe == 1)
		    pi = pi_twe;
		pi.expansion = response.expansion;
		pi.nexpansion = eval(response.expansion) + 1;
		pi.suggestion = response.suggestion;

		// personalization.
		pi.prs = response.pers;

		// engines.
		pi.engines = response.engines;
		
                //response.cpage = pi.cpage; // XXX: can't find how to pass either two objects, or embed object pi into response and still substitute...
                //response.rpp = pi.rpp; // XXX: idem...
		
		render();
	    },
	    
	    failure: function () {
                alert("fail");
                outputDiv.setContent(this.failureTemplate);
	    }
	}	
        });
	resultsWidget.send();
    }

    /* main result widget stuff. */
    snippetTxtTemplate =
        '<li class="search_snippet">' +
        '{headHTML}<a href="{url}">{title}</a>{enginesHTML}</h3>' +
	'<div>{summary}</div>' +
        '<div><cite>{cite}</cite>' +
	'<a class="search_cache" href="{cached}">Cached</a><a class="search_cache" href="{archive}">Archive</a><a class="search_cache" href="/search?q={enc_query}&amp;page=1&amp;expansion=1&amp;action=similarity&amp;id={id}&amp;engines=">Similar</a></div></li>';
    
    snippetImgTemplate =
	'<li class="search_snippet search_snippet_img">' +
	'<h3><a href="{url}"><img src="{cached}"></a><div>{title}{enginesHTML}</h3></div>' +
	'<cite>{cite}</cite><br>' +
        '<a class="search_cache" href="{cached}">Cached</a>' + //TODO: similarity.                                                     
	'</div></li>';
    
    snippetVidTemplate =
        '<li class="search_snippet search_snippet_vid"><a href="{url}"><img class="video_profile" src="{cached}"></a>' +
        '{headHTML}<a href="{url}">{title}</a>{enginesHTML}</h3>'+
	'<div><cite>{date}</cite></div></li>';
    
    snippetTweetTemplate =
	'<li class="search_snippet"><a href="{cite}"><img class="tweet_profile" src="{cached}" ></a><h3><a href="{url}">{title}</a></h3><div><cite>{cite}</cite><date> ({date})</date><a class="search_cache" href="/search?q={enc_query}&page=1&expansion=1&action=similarity&id={id}&engines=twitter,identica">Similar</a></div></li>';
    
    failureTemplate =
        '<p class="error">Ack, I couldn\'t reach the Seeks search service!</p>';
        
    function render()
    {
        //TODO: clustering.
	
	var pi;
	if (ti.txt == 1)
            pi = pi_txt;
        else if (ti.img == 1)
            pi = pi_img;
        else if (ti.vid == 1)
            pi = pi_vid;
        else if (ti.twe == 1)
	    pi = pi_twe;
	
	var rsnippets = [];
	var ns = 0;
	var snippets_html = '';
	for (id in hashSnippets)
	{
	    var snippet = hashSnippets[id];

	    // check snippet type for rendering.                                                                                   
            if (ti.txt == 1
		&& (snippet.type == "image" || snippet.type == "video_thumb" || snippet.type == "tweet"))
                continue;
            if (ti.img == 1 && snippet.type != "image")
                continue;
            else if (ti.vid == 1 && snippet.type != "video_thumb")
                continue;
            else if (ti.twe == 1 && snippet.type != "tweet")
                continue;
	    rsnippets.push(snippet);
	    ns++;
	}
	
	if (pi.prs == "on")
	{   
            rsnippets.sort(sort_score);
	}
	else
	{
            rsnippets.sort(sort_meta);
	}    
	
	var k = 0;
	for (id in rsnippets)
	{
	    var snippet = rsnippets[id]
	    
	    // check snippet type for rendering.
            /* if (ti.txt == 1
                && (snippet.type == "image" || snippet.type == "video_thumb" || snippet.type == "tweet"))
                continue;
            if (ti.img == 1 && snippet.type != "image")
                continue;
            else if (ti.vid == 1 && snippet.type != "video_thumb")
                continue;
		else if (ti.twe == 1 && snippet.type != "tweet")
                continue; */
            k++;
	    
	    if (k < (pi.cpage-1) * pi.rpp)
		continue;
	    else if (k > pi.cpage * pi.rpp)
		break;
	    	    
            // personalization & title head.                                                                                       
            if (snippet.personalized == 'yes')
            {
                snippet.headHTML = '<h3 class=\"personalized_result personalized\" title=\"personalized result\">';
            }
            else
            {
                snippet.headHTML = '<h3>';
            }
	    
            // render url capture.                                                                                                 
            if (pi.prs == "on")
            {
                snippet.url = "/qc_redir?q=" + enc_query + "&url=" + encodeURIComponent(snippet.url);
            }
	    
	    // render engines.                                                                                                     
            snippet.enginesHTML = '';
	    for (j=0, le=snippet.engines.length; j < le; ++j)
            {
                snippet.enginesHTML += '<span class=\"search_engine search_engine_' + snippet.engines[j]  + '\" title=\"' + snippet.engines[j] + '\"><a href=\"';
                snippet.enginesHTML += '@base-url@/search';
                if (ti.img == 1)
                    snippet.enginesHTML += '_img';
                snippet.enginesHTML += '?q=' + enc_query;
                snippet.enginesHTML += '&page=1&expansion=1&action=expand&engines=' + snippet.engines[j] + '\">';
                snippet.enginesHTML += '</a></span>';
            }
	    
	    // encoded query.
            snippet.enc_query = enc_query;
	    
	    if (ti.txt == 1)
		snippet.snippetHTML = Y.substitute(snippetTxtTemplate, snippet);
	    else if (ti.img == 1)
            	snippet.snippetHTML = Y.substitute(snippetImgTemplate, snippet);
	    else if (ti.vid == 1)
            	snippet.snippetHTML = Y.substitute(snippetVidTemplate, snippet);
	    else if (ti.twe == 1)
                snippet.snippetHTML = Y.substitute(snippetTweetTemplate, snippet);
            
	    snippets_html += snippet.snippetHTML;
	}
	outputDiv.setContent(snippets_html);

	// compute page number.
        var p = new rpage();
	p.cpage = pi.cpage;
	var max_page = 1;
        if (ns > 0)
            max_page = ns / pi.rpp;
        
        if (pi.cpage > 1)
        {
	    p.prev = '<a href="javascript:void(null);" id="search_page_prev" title="Previous (ctrl+&lt)">&nbsp;</a>';
        }
        if (pi.cpage < max_page)
        {
            p.next = '<a href="javascript:void(null);" id="search_page_next" title="Next (ctrl+&gt)">&nbsp;</a>';
	}
        pagesHTML = Y.substitute(pagesTemplate,p);
        pagesDiv.setContent(pagesHTML);
	
	// expansion image.
	expansionLnk.setAttribute('class',"expansion_" + String(pi.expansion));
        expansionLnk.setContent(pi.expansion);
	
	// personalization.
        var persHTMLf = Y.substitute(this.persTemplateFlag, pi);
	persSpan.setContent(persHTMLf);
	
        //TODO: content analysis...
	
        // render language.
        langSpan.setContent(lang);
	
        // query suggestion.
        suggDiv.setContent(pi.suggestion);
    }
    
    /* prev / next page rendering. */
    pagesTemplate = 
	'{prev}<span id="search_page_current">{cpage}</span>{next}<small>page</small>';
    
    /* personalization rendering. */
    persTemplateFlag = '{prs}';
    
    /* send the request. */
    refresh(ref_url);
    
    // Click the search button to send the JSONP request
    Y.one("#search_form").on("submit", function (e) {
	var nquery = queryInput.get('value');
	if (query != nquery)
	{
	    var eimg = '';
	    var pi;
	    if (ti.txt == 1)
		pi = pi_txt;
	    else if (ti.img == 1)
	    {
		pi = pi_img;
		eimg = "_img";
	    }
	    else if (ti.vid == 1)
		pi = pi_vid;
	    else if (ti.twe == 1)
		pi = pi_twe;
	    var url = '@base-url@/search' + eimg + '?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":1,"action":"expand","rpp":pi.rpp,"prs":"on","content_analysis":pi.ca,"ui":"dyn","output":"json"}) + "&engines=" + pi.engines + "&callback={callback}";
	    for (id in hashSnippets)
		delete hashSnippets[id];
            pi_txt.reset();
            pi_img.reset();
	    pi_vid.reset();
            pi_twe.reset();
 	    refresh(url);
	}
	return false;
    });
    
    Y.one("#expansion").on("click",function(e) {
	var eimg = '';
	var pi;
	if (ti.txt == 1)
            pi = pi_txt;
	else if(ti.img== 1)
	{
            pi = pi_img;
	    eimg = "_img";
	}	
	else if(ti.vid== 1)
            pi = pi_vid;
	else if(ti.twe== 1)
            pi = pi_twe;
	var url = '@base-url@/search' + eimg + '?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi.nexpansion,"action":"expand","rpp":pi.rpp,"prs":pi.pers,"content_analysis":pi.ca,"ui":"dyn","output":"json"}) + "&engines=" + pi.engines + "&callback={callback}";
	refresh(url);
	return false;
    });

    Y.one("#tab-pers").on("click",function(e) {
	var pi;
	if (ti.txt == 1)
            pi = pi_txt;
	else if(ti.img== 1)
            pi = pi_img;
	else if(ti.vid== 1)
            pi = pi_vid;
	else if(ti.twe== 1)
            pi = pi_twe;
	var nprs = "off";
	if (pi.prs == "off")
	    nprs = "on";
	var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi.expansion,"action":"expand","rpp":pi.rpp,"prs":nprs,"content_analysis":pi.ca,"ui":"dyn","output":"json"}) + "&engines=" + pi.engines + "&callback={callback}";
	refresh(url);
	return false;
    });
    
    Y.one("#tab-text").on("click",function(e) {
	ti.reset();
	ti.txt = 1;
	if (pi_txt.engines == '')
	{
	    var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi_txt.expansion,"action":"expand","rpp":pi_txt.rpp,"prs":pi_txt.pers,"content_analysis":pi_txt.ca,"ui":"dyn","output":"json"}) + "&callback={callback}";
	    refresh(url);
	}
	else render();
	return false;
    });

    Y.one("#tab-img").on("click",function(e) {
	ti.reset();
	ti.img = 1;
	if (pi_img.engines == '')
	{
	    var url = '@base-url@/search_img?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":1,"action":"expand","rpp":pi_img.rpp,"prs":pi_img.pers,"content_analysis":pi_img.ca,"ui":"dyn","output":"json"}) + "&callback={callback}";
	    refresh(url);
	}
	else render();
	return false;
    });

    Y.one("#tab-vid").on("click",function(e) {
	ti.reset();
	ti.vid = 1;
	if (pi_vid.engines == '')
	{
	    var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi_vid.expansion,"action":"expand","rpp":pi_vid.rpp,"prs":pi_vid.pers,"content_analysis":pi_vid.ca,"ui":"dyn","output":"json"}) + "&engines=youtube,dailymotion&callback={callback}";
	    refresh(url);
	}
	else render();
	return false;
    });

    Y.one("#tab-tweet").on("click",function(e) {
	ti.reset();
	ti.twe = 1;
	if (pi_twe.engines == '')
	{
	    var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi_twe.expansion,"action":"expand","rpp":40,"prs":pi_twe.pers,"content_analysis":pi_twe.ca,"ui":"dyn","output":"json"}) + "&engines=twitter,identica&callback={callback}";
	    refresh(url);
	}
	else render();
	return false;
    });

    /* Y.one("#tab-urls").on("click",function(e) {
	var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi.expansion,"action":"urls","rpp":pi.rpp,"prs":pi.pers,"content_analysis":pi.ca,"ui":"dyn","output":"json"}) + "&engines=" + pi.engines + "&callback={callback}";
	refresh(url);
	return false;
    });
    
    Y.one("#tab-titles").on("click",function(e) {
        var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"expansion":pi.expansion,"action":"titles","rpp":pi.rpp,"prs":pi.pers,"content_analysis":pi.ca,"ui":"dyn","output":"json"}) + "&engines=" + pi.engines + "&callback={callback}";
	refresh(url);
	return false;
    }); */

    Y.one("#tab-types").on("click",function(e) {
        var url = '@base-url@/search?' + Y.QueryString.stringify({"q":queryInput.get('value'),"action":"types","ui":"dyn","output":"json"}) + "&callback={callback}";
	refresh(url);
	return false;
    });
    
    /* Y.one("#search_page_prev").on("click",function(e) {
	
    });

    Y.one("#search_page_next").on("click",function(e) {
	
    }); */
    
});
 

// Shortcut for search, ctrl+s
YUI().use('event-key', function(Y) {
    var handle = Y.on('key', function(e) {
        e.halt();
        Y.one('#search_input').select();
    }, document, 'press:102+ctrl');

});

// Shortcut for expansion, ctrl+e
YUI().use('event-key', function(Y) {
    var handle = Y.on('key', function(e) {
        e.halt();
        document.location = Y.one('#expansion').getAttribute('href');
    }, document, 'press:101+ctrl');

});

// Shortcut for clustering, ctrl+c
YUI().use('event-key', function(Y) {
    var handle = Y.on('key', function(e) {
    e.halt();
    document.location = Y.one('#cluster').getAttribute('href');
    }, document, 'press:99+ctrl');


});


// Shortcut for previous page, ctrl+<
YUI().use('event-key', function(Y) { 
    var handle = Y.on('key', function(e) {
        e.halt();                    
        document.location = Y.one('#search_page_prev').getAttribute('href');
    }, document, 'press:37+ctrl');

});

// Shortcut for previous page, ctrl+>
YUI().use('event-key', function(Y) {
    var handle = Y.on('key', function(e) {
        e.halt();
        document.location = Y.one('#search_page_next').getAttribute('href');
    }, document, 'press:39+ctrl');

});

// Shortcut for home page, ctrl+h
YUI().use('event-key', function(Y) {
    var handle = Y.on('key', function(e) {
        e.halt();
        document.location = Y.one('#search_home').getAttribute('href');
    }, document, 'press:104+ctrl');

});

</script>
<!-- if-websearch-have-js-end@ -->

</div> 
</td>

<td style="vertical-align:top;">
<!-- message panel -->
<!-- @if-have-result-message-start -->
<div id="message">
<p>xxmsg</p>
<!-- img src="public/images/seek_icon_32x32_transparent.png"/> -->
</div>
<!-- if-have-result-message-end@ -->
</td>
</tr>
</table>

</body></html>
